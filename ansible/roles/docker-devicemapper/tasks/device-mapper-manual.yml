---
- name: Install direct-lvm dependencies
  yum: > 
    pkg={{item}} 
    state=installed
  with_items:
    - device-mapper-persistent-data
    - lvm2

- name: Ensure there are no partitions on the 2nd block device dedicated for Docker direct-lvm
  ignore_errors: true
  shell: 
    cmd: | 
      fdisk /dev/sdb <<EOF
      d
      w
      EOF

- name: Restart machines to clear partition table.
  shell: sleep 2 && shutdown -r now
  async: 1
  poll: 0

- name: waiting 90 secs for servers to come back
  local_action: wait_for host={{ inventory_hostname }} port=22 state=started delay=90 timeout=180
  become: false

- name: Create the physical volume
  shell: pvcreate /dev/sdb

- name: Create the logical volume
  shell: vgcreate docker /dev/sdb

- name: Create the thinpool volume
  shell: lvcreate --wipesignatures y -n thinpool docker -l 95%VG

- name: Create the thinpoolmeta volume
  shell: lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG

- name: Convert the volumes
  ignore_errors: true
  shell: 
    cmd: |
      lvconvert -y \
        --zero n \
        -c 512K \
        --thinpool docker/thinpool \
        --poolmetadata docker/thinpoolmeta

- name: Create the thinpoolmeta volume
  shell: lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG

- name: Configure the thinpool profile
  template:
    src: templates/docker-thinpool.j2
    dest: /etc/lvm/profile/docker-thinpool.profile

- name: Apply the thinpool profile change
  shell: lvchange --metadataprofile docker-thinpool docker/thinpool
    
- name: Enable LVM volume monitoring
  shell: lvs -o+seg_monitor

#- name: Create Docker Backup Folder
#  shell: mkdir /var/lib/docker.bk

#- name: Move existing docker volume data
#  shell: mv /var/lib/docker/* /var/lib/docker.bk

- name: Configure the docker daemon.json 
  template:
    src: templates/docker_daemon_devicemapper_man.j2
    dest: /etc/docker/daemon.json

#- name: 
#  blockinfile:
#    path: /etc/docker/daemon.json
#    insertbefore: "}"
#    block: |
#      
#      "storage-opts": [
#        "dm.directlvm_device=/dev/sdb",
#        "dm.thinp_percent=95",
#        "dm.thinp_metapercent=1",
#        "dm.thinp_autoextend_threshold=80",
#        "dm.thinp_autoextend_percent=20",
#        "dm.directlvm_device_force=true"
#      ]

- name: Restart the docker daemon with the new storage configuration
  service:
    name: docker
    state: restarted
    enabled: yes  
      
#- name: Remove existing docker volume data
#  shell: rm -rf /var/lib/docker.bk
      