---

- name: install the Docker Manager Firewall Service definition
  template:
    src: templates/firewalld/swarm-manager-service.j2
    dest: /etc/firewalld/services/swarm-manager.xml
    mode: 644
  when: "inventory_hostname in groups['docker_swarm_manager']"

- name: install the Docker Worker Firewall Service definition
  template:
    src: templates/firewalld/swarm-worker-service.j2
    dest: /etc/firewalld/services/swarm-worker.xml
    mode: 644
  when: "inventory_hostname in groups['docker_swarm_worker']"

- name: enable firewalld
  service:
    name: firewalld
    state: started
    enabled: yes  

- name: set default firewalld Zone to DMZ
  shell: firewall-cmd --set-default-zone=dmz

- name: enable HTTP firewalld rule
  shell: firewall-cmd --zone=dmz --add-service=http --permanent

- name: enable HTTPS firewalld rule
  shell: firewall-cmd --zone=dmz --add-service=https --permanent

- name: enable SSH firewalld rule
  shell: firewall-cmd --zone=dmz --add-service=ssh --permanent

- name: enable docker manager firewall rules
  shell: firewall-cmd --zone=dmz --add-service=swarm-manager --permanent
  when: "inventory_hostname in groups['docker_swarm_manager']"

- name: enable docker worker firewall rules
  shell: firewall-cmd --zone=dmz --add-service=swarm-worker --permanent
  when: "inventory_hostname in groups['docker_swarm_worker']"

- name: reload the firewalld rules
  shell: firewall-cmd --reload

- name: list the active firewalld rules
  shell: firewall-cmd --list-all    
  register: firewalld_rules

- debug: msg="{{ firewalld_rules.stdout_lines }}"

- name: restart the docker daemon with the new firewall rules
  service:
    name: docker
    state: restarted
    enabled: yes  

