
- name: Patch CoreDNS memory limit to deal with bug in 1.12.1
  shell: "kubectl patch deployment -n=kube-system coredns -p '{\"spec\": {\"template\": {\"spec\":{\"containers\":[{\"image\":\"k8s.gcr.io/coredns:1.2.2\", \"name\":\"coredns\",\"resources\":{\"limits\":{\"memory\":\"512Mi\"},\"requests\":{\"cpu\":\"100m\",\"memory\":\"70Mi\"}}}]}}}}'"
  register: patch_out

- debug: msg="{{ patch_out.stdout_lines }}"

- name: Install Canal RBAC manifest
  shell: kubectl apply -f https://docs.projectcalico.org/v3.2/getting-started/kubernetes/installation/hosted/canal/rbac.yaml
  register: rbac_out

- debug: msg="{{ rbac_out.stdout_lines }}"

- name: Install Canal manifest
  shell: kubectl apply --validate=false -f https://docs.projectcalico.org/v3.2/getting-started/kubernetes/installation/hosted/canal/canal.yaml
  register: canal_out

- debug: msg="{{ canal_out.stdout_lines }}"

- name: Install Flannel CNI manifest
  shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  register: flannel_out

- debug: msg="{{ flannel_out.stdout_lines }}"

- name: Copy Dashboard UI manifest files to node
  copy:
    src: "{{ playbook_dir | replace('/ansible', '') }}/xtras/k8s/dashboard"
    dest: /root/

- name: Install Grafana manifest
  shell: kubectl apply -f /root/dashboard/grafana.yml
  register: graf_out

- debug: msg="{{ graf_out.stdout_lines }}"

- name: Install Heapster RBAC manifest
  shell: kubectl apply -f /root/dashboard/heapster-rbac.yml
  register: heap_out

- debug: msg="{{ heap_out.stdout_lines }}"

- name: Install InfluxDB manifest
  shell: kubectl apply -f /root/dashboard/influxdb.yml
  register: influx_out

- debug: msg="{{ influx_out.stdout_lines }}"

- name: Install Kubernetes Dashboard manifest
  shell: kubectl apply -f /root/dashboard/kubernetes-dashboard.yml
  register: dash_out

- debug: msg="{{ dash_out.stdout_lines }}"