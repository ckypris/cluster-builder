
#- name: patch CoreDNS memory limit to deal with bug in 1.12.1
#  shell: "kubectl patch deployment -n=kube-system coredns -p '{\"spec\": {\"template\": {\"spec\":{\"containers\":[{\"image\":\"k8s.gcr.io/coredns:1.2.2\", \"name\":\"coredns\",\"resources\":{\"limits\":{\"memory\":\"512Mi\"},\"requests\":{\"cpu\":\"100m\",\"memory\":\"70Mi\"}}}]}}}}'"
#  register: patch_out

#- debug: msg="{{ patch_out.stdout_lines }}"

- name: configure Canal CNI network plugin
  include: canal.yml
  when: k8s_network_cni == "canal"

- name: configure Calico CNI network plugin
  include: calico.yml
  when: k8s_network_cni == "calico" or k8s_network_cni == "calico-policy"

- name: apply the temporary coredns loop patch 
  include: coredns-loop.yml
  when: k8s_coredns_loop_check_disable is defined

- name: configure Calico CNI Network Policy 
  include: calico-policy.yml
  when: k8s_network_cni == "calico-policy"

- name: configure Traefik ingress controller 
  include: traefik.yml
  when: k8s_ingress_controller == "traefik-daemonset" or k8s_ingress_controller == "traefik-deployment"

- name: configure NGINX ingress controller 
  include: nginx.yml
  when: k8s_ingress_controller == "nginx"

- name: configure the Kubernetes Dashboard 
  include: kubernetes-dashboard.yml

#- name: configure MetalLB on premise Load Balancer  
#  include: metal-lb.yml
#  when: k8s_metallb_address_range is defined
