
- name: patch CoreDNS memory limit to deal with bug in 1.12.1
  shell: "kubectl patch deployment -n=kube-system coredns -p '{\"spec\": {\"template\": {\"spec\":{\"containers\":[{\"image\":\"k8s.gcr.io/coredns:1.2.2\", \"name\":\"coredns\",\"resources\":{\"limits\":{\"memory\":\"512Mi\"},\"requests\":{\"cpu\":\"100m\",\"memory\":\"70Mi\"}}}]}}}}'"
  register: patch_out

- debug: msg="{{ patch_out.stdout_lines }}"

- name: install canal RBAC manifest
  shell: kubectl apply -f https://docs.projectcalico.org/v3.2/getting-started/kubernetes/installation/hosted/canal/rbac.yaml
  register: rbac_out

- debug: msg="{{ rbac_out.stdout_lines }}"

- name: install canal manifest
  shell: kubectl apply --validate=false -f https://docs.projectcalico.org/v3.2/getting-started/kubernetes/installation/hosted/canal/canal.yaml
  register: canal_out

- debug: msg="{{ canal_out.stdout_lines }}"

- name: install flannel CNI manifest
  shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  register: flannel_out

- debug: msg="{{ flannel_out.stdout_lines }}"

- name: install InfluxDB manifest
  shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/influxdb.yaml
  register: influx_out

- debug: msg="{{ influx_out.stdout_lines }}"

- name: install Grafana manifest
  shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/grafana.yaml
  register: graf_out

- debug: msg="{{ graf_out.stdout_lines }}"

- name: configure the heapster metrics service
  include: heapster.yml
  when: "install_metrics_server is undefined"

- name: configure the metrics server service
  include: metric-server.yml
  when: "install_metrics_server is defined"

- name: copy customized traefik manifest
  copy:
    src: "{{ playbook_dir | replace('/ansible', '') }}/xtras/k8s/traefik-nodeport.yml"
    dest: /root/

- name: install traefik ingress controller manifest
  shell: kubectl apply -f /root/traefik-nodeport.yml
  register: traefik_out

- debug: msg="{{ traefik_out.stdout_lines }}"

- name: install kubernetes dashboard manifest
  shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
  register: dash_out

- debug: msg="{{ dash_out.stdout_lines }}"