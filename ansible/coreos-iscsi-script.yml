- hosts: coreos_controllers,coreos_workers
  become: true
  any_errors_fatal: true
  gather_facts: false
  vars:

    tectonic_controller_domain: "{{ tectonic_controller_dn }}"
    tectonic_matchbox_http_url: "http://{{ provisioner_server_dn }}:8080"
    tectonic_matchbox_rpc_endpoint: "{{ provisioner_server_dn }}:8081"
    tectonic_ingress_domain: "{{ tectonic_ingress_dn }}"
    tectonic_service_cidr: "10.3.0.0/16"
    tectonic_coreos_user: core

  roles:
    - common

  tasks:

  - name: Generate custom iSCSI Kublet service def
    local_action:
      module: template
      src: templates/coreos-kubelet-service-iscsi.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/coreos-kublet-service
      mode: 0766
    become: false
    run_once: true
    when: tectonic_networking != "canal"

  - name: Generate custom iSCSI/Canal Kublet service def
    local_action:
      module: template
      src: templates/coreos-kubelet-service-iscsi-canal.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/coreos-kublet-service
      mode: 0766
    become: false
    run_once: true
    when: tectonic_networking == "canal"

  - name: Generate the iSCSI script
    local_action:
      module: template
      src: templates/coreos-iscsi-script.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/coreos-iscsi.sh
      mode: 0766
    run_once: true
    become: false

  - name: Ensure the iscs-manifests folder exists in the cluster package
    local_action:
      module: shell
      _raw_params: mkdir -p ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests
    become: false
    run_once: true
    when: targetd_server is defined 

  - name: Read VM Node Initiator value for storage class 
    shell: CODE=`cat /etc/iscsi/initiatorname.iscsi` && echo ${CODE//InitiatorName=/}
    register: vm_initiator_code
    when: targetd_server is defined 

  - name: Assign fact 
    set_fact:
      initiator_name: "{{ vm_initiator_code.stdout }}"
    when: targetd_server is defined 

  - name: Generate the iSCSI provisioner, roles and storage class manifest
    local_action:
      module: template
      src: templates/coreos-iscsi-manifests.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests/coreos-iscsi.yml
      mode: 0766
    become: false
    run_once: true
    when: targetd_server is defined 

  - name: Generate the iSCSI Benchmark manifest
    local_action:
      module: template
      src: templates/coreos-iscsi-bench.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests/coreos-iscsi-bench.yml
      mode: 0766
    become: false
    run_once: true
    when: targetd_server is defined 

  - name: Generate the iSCSI provisioner secret script
    local_action:
      module: template
      src: templates/coreos-iscsi-secret.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests/coreos-iscsi-secret.sh
      mode: 0766
    become: false    
    run_once: true
    when: targetd_server is defined     