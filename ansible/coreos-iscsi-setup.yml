- hosts: coreos_workers
  become: true
  any_errors_fatal: true
  gather_facts: false

  roles:
    - common

  tasks:

  - name: Enable and Start the iSCSId.
    shell: systemctl enable iscsid && systemctl start iscsid

  - name: Add iSCSI configuration to kubelet.service file
    lineinfile:
      dest: /etc/systemd/system/kubelet.service
      regexp: "{{ item.regx }}"
      line: "{{ item.line }}"
      state: present
      insertafter: 'Environment="RKT_RUN_ARGS='
    with_items:
      - { regx: "  --volume iscsiadm,kind=host", line: '  --volume iscsiadm,kind=host,source=/usr/sbin/iscsiadm --mount volume=iscsiadm,target=/usr/sbin/iscsiadm \' }

  - name: Add iSCSI configuration to kubelet.service file
    lineinfile:
      dest: /etc/systemd/system/kubelet.service
      regexp: "{{ item.regx }}"
      line: "{{ item.line }}"
      state: present
      insertafter: '--volume iscsiadm'
    with_items:
      - { regx: "  --volume etc-scsi,kind=host", line: '  --volume etc-scsi,kind=host,source=/etc/iscsi/ --mount volume=etc-scsi,target=/etc/iscsi \' }

  - name: Add iSCSI configuration to kubelet.service file
    lineinfile:
      dest: /etc/systemd/system/kubelet.service
      regexp: "{{ item.regx }}"
      line: "{{ item.line }}"
      state: present
      insertafter: '--volume etc-scsi'
    with_items:
      - { regx: "  --volume iscsid,kind=host", line: '  --volume iscsid,kind=host,source=/usr/sbin/iscsid --mount volume=iscsid,target=/usr/sbin/iscsid \' }

  - name: Add iSCSI configuration to kubelet.service file
    lineinfile:
      dest: /etc/systemd/system/kubelet.service
      regexp: "{{ item.regx }}"
      line: "{{ item.line }}"
      state: present
      insertafter: '--volume iscsid'
    with_items:
      - { regx: "  --volume mkfsext4,kind=host", line: '  --volume mkfsext4,kind=host,source=/usr/sbin/mkfs.ext4 --mount volume=mkfsext4,target=/usr/sbin/mkfs.ext4 \' }

  - name: Add iSCSI configuration to kubelet.service file
    lineinfile:
      dest: /etc/systemd/system/kubelet.service
      regexp: "{{ item.regx }}"
      line: "{{ item.line }}"
      state: present
      insertafter: '--volume mkfsext4'
    with_items:
      - { regx: "  --volume mkfsfat,kind=host", line: '  --volume mkfsfat,kind=host,source=/usr/sbin/mkfs.fat --mount volume=mkfsfat,target=/usr/sbin/mkfs.fat \' }

  - name: Reload unit file
    shell: systemctl daemon-reload

  - name: Restart the Kubelets.
    shell: systemctl restart kubelet

  - name: Enable and Start the RPCBind.
    shell: systemctl enable rpcbind && systemctl start rpcbind

  - name: Ensure the iscs-manifests folder exists in the cluster package
    local_action:
      module: shell
      _raw_params: mkdir -p ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests
    become: false
    when: targetd_server is defined 

  - name: Read VM Node Initiator value for storage class 
    shell: CODE=`cat /etc/iscsi/initiatorname.iscsi` && echo ${CODE//InitiatorName=/}
    register: vm_initiator_code
    when: targetd_server is defined 

  - name: Assign fact 
    set_fact:
      initiator_name: "{{ vm_initiator_code.stdout }}"
    when: targetd_server is defined 

  - name: Generate the iSCSI provisioner, roles and storage class manifest
    local_action:
      module: template
      src: templates/coreos-iscsi-manifests.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests/coreos-iscsi.yml
      mode: 0766
    become: false
    when: targetd_server is defined 

  - name: Generate the iSCSI Benchmark manifest
    local_action:
      module: template
      src: templates/coreos-iscsi-bench-pvc-yml.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests/coreos-iscsi-bench-pvc.yml
      mode: 0766
    become: false
    run_once: true
    when: targetd_server is defined 

  - name: Generate the iSCSI Benchmark manifest
    local_action:
      module: template
      src: templates/coreos-iscsi-bench-job-yml.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests/coreos-iscsi-bench-job.yml
      mode: 0766
    become: false
    run_once: true
    when: targetd_server is defined 

  - name: Generate the iSCSI provisioner secret script
    local_action:
      module: template
      src: templates/coreos-iscsi-secret.j2
      dest: ../clusters/{{ cluster_pkg_folder }}/iscsi-manifests/coreos-iscsi-secret.sh
      mode: 0766
    become: false    
    when: targetd_server is defined 
    